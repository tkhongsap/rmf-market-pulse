#!/usr/bin/env node
/**
 * RMF JSON Files Validator
 *
 * This script validates all JSON files in data/rmf-funds/ and reports:
 * - Null value statistics
 * - Funds without mapping
 * - Funds with SEC API data vs offline metadata only
 *
 * Usage: node utility/validate-rmf-json-files.js
 */

const fs = require('fs');
const path = require('path');

const dir = path.join(__dirname, '..', 'data', 'rmf-funds');

// Check if directory exists
if (!fs.existsSync(dir)) {
  console.error('❌ Directory not found: data/rmf-funds/');
  console.error('   Please generate the JSON files first.');
  process.exit(1);
}

const files = fs.readdirSync(dir).filter(f => f.endsWith('.json'));

console.log('='.repeat(80));
console.log('JSON FILE VALIDATION REPORT');
console.log('='.repeat(80));
console.log(`\nTotal files: ${files.length}`);

let filesWithNullValues = 0;
let nullFieldCounts = {};
let fundsWithoutMapping = [];
let fundsWithData = [];

files.forEach(file => {
  const content = fs.readFileSync(path.join(dir, file), 'utf-8');
  const data = JSON.parse(content);

  let hasNulls = false;
  let nullCount = 0;

  // Check all top-level fields for nulls
  for (const [key, value] of Object.entries(data)) {
    if (value === null) {
      hasNulls = true;
      nullCount++;
      nullFieldCounts[key] = (nullFieldCounts[key] || 0) + 1;
    }
  }

  if (hasNulls) {
    filesWithNullValues++;
  }

  // Track funds without mapping
  if (data.fund_id === null) {
    fundsWithoutMapping.push({
      symbol: data.symbol,
      fund_name: data.fund_name
    });
  }

  // Track funds that have actual data
  if (data.latest_nav !== null || data.performance !== null) {
    fundsWithData.push(data.symbol);
  }
});

console.log(`\n${'─'.repeat(80)}`);
console.log('SUMMARY');
console.log('─'.repeat(80));
console.log(`Files with null values: ${filesWithNullValues} / ${files.length}`);
console.log(`Funds without mapping: ${fundsWithoutMapping.length}`);
console.log(`Funds with SEC API data: ${fundsWithData.length}`);

console.log(`\n${'─'.repeat(80)}`);
console.log('NULL FIELD BREAKDOWN');
console.log('─'.repeat(80));

// Sort by count descending
const sortedFields = Object.entries(nullFieldCounts).sort((a, b) => b[1] - a[1]);
sortedFields.forEach(([field, count]) => {
  const pct = ((count / files.length) * 100).toFixed(1);
  console.log(`  ${field.padEnd(25)} ${count.toString().padStart(3)} (${pct}%)`);
});

console.log(`\n${'─'.repeat(80)}`);
console.log('DIAGNOSIS');
console.log('─'.repeat(80));

if (fundsWithData.length === 0) {
  console.log('❌ All files contain OFFLINE metadata only (no SEC API data)');
  console.log('   These files were generated by generate-offline-rmf-funds.ts');
  console.log('   which intentionally sets most fields to null.');
} else if (fundsWithData.length === files.length) {
  console.log(`✓ All ${fundsWithData.length} files contain SEC API data`);
} else {
  console.log(`⚠️  Partial data: ${fundsWithData.length} / ${files.length} files contain SEC API data`);
}

if (fundsWithoutMapping.length > 0) {
  console.log(`\n⚠️  ${fundsWithoutMapping.length} funds are missing from fund-mapping.json:`);
  console.log('   These funds have null fund_id and mapping_snapshot.');
  fundsWithoutMapping.slice(0, 10).forEach(f => {
    console.log(`   - ${f.symbol}`);
  });
  if (fundsWithoutMapping.length > 10) {
    console.log(`   ... and ${fundsWithoutMapping.length - 10} more`);
  }
}

console.log(`\n${'='.repeat(80)}`);
console.log('RECOMMENDATION');
console.log('='.repeat(80));

if (fundsWithData.length === 0) {
  console.log('To populate these JSON files with complete SEC API data:');
  console.log('  1. Ensure SEC API keys are configured in .env file');
  console.log('  2. Run: npx tsx tests/api/fetch-all-rmf-funds.ts');
  console.log('  3. This will fetch complete data for all 410 RMF funds');
} else if (fundsWithData.length < files.length) {
  console.log('Some files are missing SEC API data. To refresh all files:');
  console.log('  1. Delete data/progress.json (if exists)');
  console.log('  2. Run: npx tsx tests/api/fetch-all-rmf-funds.ts');
} else {
  console.log('✓ All files are up to date with SEC API data');
}

if (fundsWithoutMapping.length > 0) {
  console.log('\nTo fix missing fund mappings:');
  console.log('  1. Review data/fund-mapping.json');
  console.log('  2. Add missing symbols manually or update mapping generation script');
}

console.log('='.repeat(80));

// Exit with error code if validation fails
if (fundsWithData.length === 0 || fundsWithoutMapping.length > 0) {
  process.exit(1);
} else {
  process.exit(0);
}
